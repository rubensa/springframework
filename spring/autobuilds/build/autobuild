#!/bin/sh
#
# autobuild
#
# run with params:
#    -u [optional]  - to force a CVS update of Spring source
#    -k [optional]  - to keep the servers alive after tests end
#    application    - the sample app to build and test
#    server         - the target server to deploy upon
#
# $Id$
#
# ---------------------------------------------------------------------------

ANT=ant
USAGE="Usage: $0 [-u] sample-app target-server"
LOGGER=org.apache.tools.ant.DefaultLogger
LISTENER=org.apache.tools.ant.XmlLogger
PARAMS=$@

# ---------------------------------------------------------------------------

# get opts
for p in $PARAMS; do
    GOTOP=0
    if [ $p = "-u" ]; then
        DOCVS="-Dcvs.update=yes"
        GOTOP=1
    fi
    if [ $p = "-k" ]; then
        KEEPALIVE="-Dautobuilds.keepalive=yes"
        GOTOP=1
    fi
    if [[ $GOTOP = 0 ]]; then
        if [[ $APP = "" ]]; then
            APP=$p
        elif [[ $SERVER = "" ]]; then
            SERVER=$p
        fi
    fi
done
BUILDLOG=../../target/autobuilds/reports/${APP}_${SERVER}_build_`(date +"%Y-%m-%d")`.log

if [ ! -f build.properties ]; then
	echo "*** NO build.properties FILE!  DEFAULT VALUES WILL BE USED ***"
fi

if [ ! -f $SERVER-build.xml ]; then
	echo "Don't know about server $SERVER"
	exit 2
fi

if [ ! -f ../../samples/$APP/.autobuilds ]; then
    echo "Don't know about application $APP or application is not configured for autobuilds"
    exit 3
fi

# ensure environment exists for 1st use
$ANT -q setup > /dev/null
echo Please see the file $BUILDLOG for build logging and unit test results
$ANT -logger $LOGGER -logfile $BUILDLOG $DOCVS $KEEPALIVE -Dtarget.app=$APP -Dtarget.server=$SERVER main

exit 0
